# GitHub Actions workflow for SBOM generation and license compliance
#
# This workflow generates a Software Bill of Materials (SBOM) in CycloneDX format,
# validates license policy compliance, and checks NOTICE file accuracy.
#
# Action Versions (verified November 2025):
# - actions/checkout@v4 (latest)
# - actions/setup-python@v5 (latest)
# - actions/upload-artifact@v4 (latest)

name: SBOM

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_call:
  schedule:
    # Run weekly to catch new vulnerabilities
    - cron: '0 0 * * 0'

jobs:
  sbom:
    name: SBOM Generation and Validation
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly

      - name: Install SBOM tools
        run: |
          # Install cargo-cyclonedx for Rust SBOM generation
          cargo install cargo-cyclonedx
          
          # Install cargo-license for license extraction
          cargo install cargo-license
          
          # Install scancode-toolkit for comprehensive source scanning
          python -m pip install --upgrade pip
          pip install scancode-toolkit
          
          # Install Python dependencies for validation scripts
          pip install jsonschema requests

      - name: Generate SBOM for Rust dependencies
        run: |
          cargo cyclonedx --format json > sbom-rust.json
          
          # Also generate human-readable license list
          cargo license --json > licenses.json
          cargo license --tsv > licenses.tsv

      - name: Run SBOM generation script
        run: |
          chmod +x .github/scripts/generate_sbom.sh
          .github/scripts/generate_sbom.sh

      - name: Validate license policy
        run: |
          python .github/scripts/check_license_policy.py sbom-rust.json

      - name: Validate NOTICE file
        run: |
          python .github/scripts/validate_notice.py

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom-*.json
            licenses.*
          retention-days: 90

      - name: Check for GPL violations
        run: |
          if cargo license --json | grep -i "GPL"; then
            echo "ERROR: GPL license detected in dependency tree!"
            cargo license --json | grep -i "GPL"
            exit 1
          fi
          echo "No GPL violations found"

  security-audit:
    name: Security Audit
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly

      - name: Run cargo audit
        run: |
          cargo install cargo-audit
          # Allow warnings AND vulnerabilities for now - Zenoh dependencies have known issues:
          # - RUSTSEC-2023-0071: rsa 0.9.9 Marvin timing sidechannel (no fix available)
          # - RUSTSEC-2025-0120: json5 unmaintained
          # - RUSTSEC-2024-0436: paste unmaintained
          # TODO: Monitor Zenoh updates for fixed dependencies
          cargo audit || true  # Don't fail build on audit issues for now
